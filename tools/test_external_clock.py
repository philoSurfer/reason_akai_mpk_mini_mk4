#!/usr/bin/env python3
"""
Test sending the External Clock preset to MPK Mini IV.
Run with Reason CLOSED to avoid port conflicts.
"""

import mido
import time

# The preset SysEx with arp_clock = 1 (External)
PRESET_SYSEX = bytes([
    0x47, 0x00, 0x5D, 0x67, 0x02, 0x3B,  # Header
    0x02,  # Preset slot 2
    0x52, 0x65, 0x61, 0x73, 0x6F, 0x6E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  # "Reason" name
    0x09,  # pad_channel (10)
    0x04,  # key_channel (5)
    0x0C,  # octave
    0x00,  # transpose
    0x78,  # arp_tempo (120)
    0x03,  # arp_mode
    0x01,  # arp_time_div
    0x01,  # arp_clock = 1 (EXTERNAL) <-- THE KEY CHANGE
    0x00,  # arp_latch
    0x01,  # arp_swing
    0x00,  # arp_octave
    0x7F, 0x00, 0x01, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x32, 0x32, 0x00, 0x32, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x10, 0x0A,
    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
    0x00, 0x04, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
    # Pad mappings (notes 36-51)
    0x24, 0x00, 0x10, 0x01, 0x0E,
    0x25, 0x01, 0x11, 0x01, 0x0E,
    0x26, 0x02, 0x12, 0x01, 0x0E,
    0x27, 0x03, 0x13, 0x01, 0x0E,
    0x28, 0x04, 0x14, 0x01, 0x0E,
    0x29, 0x05, 0x15, 0x01, 0x0E,
    0x2A, 0x06, 0x16, 0x01, 0x0E,
    0x2B, 0x07, 0x17, 0x01, 0x0E,
    0x2C, 0x08, 0x18, 0x01, 0x0E,
    0x2D, 0x09, 0x19, 0x01, 0x0E,
    0x2E, 0x0A, 0x1A, 0x01, 0x0E,
    0x2F, 0x0B, 0x1B, 0x01, 0x0E,
    0x30, 0x0C, 0x1C, 0x01, 0x0E,
    0x31, 0x0D, 0x1D, 0x01, 0x0E,
    0x32, 0x0E, 0x1E, 0x01, 0x0E,
    0x33, 0x0F, 0x1F, 0x01, 0x0E,
    # Knob mappings
    0x18, 0x00, 0x7F, 0x00, 0x4B, 0x6E, 0x6F, 0x62, 0x31, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x19, 0x00, 0x7F, 0x00, 0x4B, 0x6E, 0x6F, 0x62, 0x32, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x1A, 0x00, 0x7F, 0x00, 0x4B, 0x6E, 0x6F, 0x62, 0x33, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x1B, 0x00, 0x7F, 0x00, 0x4B, 0x6E, 0x6F, 0x62, 0x34, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x1C, 0x00, 0x7F, 0x00, 0x4B, 0x6E, 0x6F, 0x62, 0x35, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x1D, 0x00, 0x7F, 0x00, 0x4B, 0x6E, 0x6F, 0x62, 0x36, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x1E, 0x00, 0x7F, 0x00, 0x4B, 0x6E, 0x6F, 0x62, 0x37, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x1F, 0x00, 0x7F, 0x00, 0x4B, 0x6E, 0x6F, 0x62, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
])

def list_ports():
    print("Available MIDI outputs:")
    for name in mido.get_output_names():
        print(f"  - {name}")
    print()

def send_preset():
    # Find the Software Port
    port_name = None
    for name in mido.get_output_names():
        if 'MPK mini' in name and 'Software' in name:
            port_name = name
            break

    if not port_name:
        print("ERROR: MPK mini IV Software Port not found!")
        list_ports()
        return False

    print(f"Sending preset to: {port_name}")
    print(f"Preset data length: {len(PRESET_SYSEX)} bytes")
    print(f"arp_clock byte (offset 31): 0x{PRESET_SYSEX[31]:02X} ({'External' if PRESET_SYSEX[31] == 1 else 'Internal'})")
    print()

    try:
        with mido.open_output(port_name) as port:
            msg = mido.Message('sysex', data=PRESET_SYSEX)
            port.send(msg)
            print("âœ“ Preset sent successfully!")
            print()
            print("Now switch presets on the MPK Mini IV:")
            print("  1. Press PROG SELECT + Pad 1 (switch to Preset 1)")
            print("  2. Press PROG SELECT + Pad 2 (switch back to Preset 2)")
            print("  3. Check if arpeggiator now shows External clock")
            return True
    except Exception as e:
        print(f"ERROR sending preset: {e}")
        return False

if __name__ == '__main__':
    print("=" * 50)
    print("MPK Mini IV External Clock Test")
    print("=" * 50)
    print()
    list_ports()
    send_preset()
